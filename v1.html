<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="sketch.js">
</script>
<script>

    var paths = [];
    var ctx;
    var undone = [];
    var THUMBNAIL_HEIGHT_RATIO = 200/500;
    var THUMBNAIL_WIDTH_RATIO = 400/1500;
    var NEW_PATH_MARGIN = 50;
  window.onload = function(){
    var inPath = false;
    var lastTouch;
    var PATH_TIME_MARGIN = 5000;
    ctx = Sketch.create({
      autoclear: false,
      draw: function() {
        
        this.lineCap = 'round';
                this.lineJoin = 'round';
                this.fillStyle = this.strokeStyle = "BLACK";
                this.lineWidth = 10;

                // for ( var i = this.touches.length - 1, touch; i >= 0; i-- ) {

                    touch = this.touches[0];
                    if(typeof touch === 'undefined'){
                    if(Date.now() - lastTouch > PATH_TIME_MARGIN && inPath){
                      inPath = false;
                      ctx.closePath();
                      // console.table(paths)
                    }
                      return;
                      
                    }

            if(!inPath){
              ctx.beginPath();
              inPath = true;
              paths.push({pts:[]})
            }
              lastTouch = Date.now();

                    

                    // this.beginPath();
                    var ox = touch.ox;
                    var oy = touch.oy;
                    // if(Math.abs(touch.x - ox) > 1000 || Math.abs(touch.y - oy) > 1000){
                    //  ox = touch.x;
                    //  oy = touch.y;
                    // }
                    this.moveTo( ox, oy );
                    this.lineTo( touch.x, touch.y );
                    paths[paths.length - 1].pts.push([touch.x, touch.y])
                    this.stroke();
                // }
            }


    });
  };


  function draw(context, path, color='black', lineWidth=10){
    // if(color == 'red')
    //  console.log(path);
    context.strokeStyle = color;
    context.lineCap = 'round';
        context.lineJoin = 'round';
        context.fillStyle = color;;
        context.lineWidth = lineWidth;
    context.beginPath();
    context.moveTo(path.pts[0][0], path.pts[0][1]);
    var lastX = path.pts[0][0];
    var lastY = path.pts[0][1];
    for(var i = 1; i < path.pts.length; i++){
      // context.stroke();
      ox = path.pts[i][0];
      oy = path.pts[i][1];
      if(Math.abs(lastX - ox) > NEW_PATH_MARGIN * THUMBNAIL_WIDTH_RATIO || Math.abs(lastY - oy) > NEW_PATH_MARGIN * THUMBNAIL_HEIGHT_RATIO){
              context.moveTo(ox,oy);
            }
            lastX = ox;
            lastY = oy;
            // if(color=='red')
            // console.log(ox,oy);
      context.lineTo(ox, oy);
      context.stroke();
    }
  }

  function clearCanvas(){
    // ctx.clear();
    ctx.clearRect(0, 0, 2000, 2000);

  }

  function redrawPaths(){
    for(var i = 0; i < paths.length; i++){

      path = paths[i];
      draw(ctx, path);
    }
    // ctx.closePath();
    // ctx.stroke();
  }

  function transformSize(path){
    var pathChanged = path;
    for(var i = 0; i < path.pts.length; i++){
      pathChanged.pts[i][0] = pathChanged.pts[i][0] * THUMBNAIL_WIDTH_RATIO;
      pathChanged.pts[i][1] = pathChanged.pts[i][1] * THUMBNAIL_HEIGHT_RATIO;
    }
    return pathChanged;
  }

  function addToUndone(path){

    undone.push(transformSize(path));
    $("#undone").append("<div style='border-style: solid'><canvas height='200' width='400'></canvas></div>")
    draw($("#undone").children().last().children().first()[0].getContext('2d'), path,  'red', 5);
  }

  function undo(){
    // ctx.autoclear = true;
    clearCanvas();
      addToUndone(paths.pop());
      redrawPaths();
    
    // ctx.autoclear = false;
  }
</script>
</head>
<body>
  <div style="background-color: red; margin-bottom:20px;">hello</div>
  <button onclick="undo()">click me!</button>
  <div id="undone">

  </div>
</body>
</html>